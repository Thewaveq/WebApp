<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Multi-Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root {
            --bg-main: #1e1e1e;
            --bg-sidebar: #252526;
            --bg-element: #333333;
            --bg-input: #3c3c3c;
            --text-primary: #f5f5f5;
            --text-secondary: #b0b0b0;
            --accent: #0e639c;
            --accent-hover: #1177bb;
            --border-color: #4a4a4a;
            --danger: #e53e3e;
            --danger-hover: #c53030;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
        }
        input, textarea, select {
            color: var(--text-primary);
        }
        input::placeholder, textarea::placeholder {
            color: var(--text-secondary);
        }
        .bg-input {
            background-color: var(--bg-input);
        }
        .sidebar-item.active { background-color: var(--accent); color: white; }
        .sidebar-item:hover { background-color: var(--bg-element); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-sidebar); }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
        .typing-indicator span { height: 8px; width: 8px; background-color: var(--accent); border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .prose { color: var(--text-primary); }
        .prose h1, .prose h2, .prose h3 { color: white; border-bottom: 1px solid var(--border-color); }
        .prose a { color: var(--accent-hover); }
        .prose pre { background-color: #282c34; padding: 1rem; border-radius: 0.5rem; position: relative; margin-top: 1.25em; margin-bottom: 1.25em; }
        .prose code { background-color: var(--bg-element); padding: 0.2rem 0.4rem; border-radius: 0.3rem; font-family: 'Courier New', Courier, monospace; }
        .prose pre code { background-color: transparent; padding: 0; border-radius: 0; }
        .prose blockquote { border-left-color: var(--accent); }
        .copy-code-btn { position: absolute; top: 0.5rem; right: 0.5rem; background-color: var(--bg-element); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 0.3rem; padding: 0.25rem; opacity: 0.5; transition: opacity 0.2s; }
        .prose pre:hover .copy-code-btn { opacity: 1; }
        .copy-code-btn:hover { background-color: var(--bg-input); color: var(--text-primary); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: var(--bg-element); padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        /* ИЗМЕНЕНИЕ 1: Стили для сворачиваемой боковой панели */
        .sidebar-transition { transition: width 0.3s ease-in-out, padding 0.3s ease-in-out; }
        .sidebar-collapsed { width: 4.5rem; padding-left: 0; padding-right: 0; }
        .sidebar-collapsed .sidebar-label, .sidebar-collapsed #user-profile-details { display: none; }
        .sidebar-collapsed #auth-section { justify-content: center; }
        .sidebar-collapsed .sidebar-item { justify-content: center; }
        .sidebar-collapsed #sidebar-header { justify-content: center; }
        .main-content-expanded { width: calc(100% - 4.5rem); }
        .icon-btn {
            background-color: var(--bg-element);
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .icon-btn:hover {
            background-color: var(--bg-input);
        }
    </style>
</head>
<body class="h-screen w-screen flex overflow-hidden">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, setDoc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ГЛОБАЛЬНОЕ СОСТОЯНИЕ И КОНФИГУРАЦИЯ ---
        const firebaseConfig = {
            apiKey: "AIzaSyDZ3u9scjk3dydutXO0EUrWlpUnsp4OuqA",
            authDomain: "appllm.firebaseapp.com",
            projectId: "appllm",
            storageBucket: "appllm.appspot.com",
            messagingSenderId: "926733538345",
            appId: "1:926733538345:web:dac990973b29ca574ff938",
            measurementId: "G-YX6FY680C9"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let db, auth, userId;
        let unsubscribeSessions = () => {};
        let unsubscribeProviders = () => {};

        // ИЗМЕНЕНИЕ 2: Обновленная структура состояния
        let state = {
            currentView: 'welcome', // 'welcome', 'session', 'settings'
            activeSessionId: null,
            sessions: [],
            providers: [],
            isLoading: false,
            isAuthReady: false,
            isSidebarCollapsed: false,
        };
        
        let confirmModalCallback = null;
        const markdownConverter = new showdown.Converter({ tables: true, strikethrough: true, tasklists: true, simpleLineBreaks: true, openLinksInNewWindow: true, ghCompatibleHeaderId: true });
        
        const sidebar = document.getElementById('sidebar');
        const sidebarList = document.getElementById('sidebar-list');
        const mainContent = document.getElementById('main-content');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmModalYesBtn = document.getElementById('confirm-modal-yes');
        const confirmModalNoBtn = document.getElementById('confirm-modal-no');

        // --- ФУНКЦИИ РЕНДЕРИНГА ---
        function render() {
            if (!state.isAuthReady) return;
            renderSidebar();
            renderMainContent();
        }

        function renderSidebar() {
            sidebarList.innerHTML = '';
            
            // ИЗМЕНЕНИЕ 3: Применение стилей для свернутой панели
            sidebar.classList.toggle('sidebar-collapsed', state.isSidebarCollapsed);
            mainContent.parentElement.classList.toggle('main-content-expanded', state.isSidebarCollapsed);

            if (state.sessions.length > 0) {
                state.sessions.forEach(session => {
                    const item = document.createElement('div');
                    item.className = `sidebar-item flex items-center p-2 my-1 rounded-md cursor-pointer transition-colors duration-200 ${session.id === state.activeSessionId ? 'active' : ''}`;
                    // Иконка в зависимости от типа сессии
                    const icon = session.type === 'chat' ? 'message-square' : 'notebook';
                    item.innerHTML = `
                        <i data-lucide="${icon}" class="w-5 h-5 mr-3 flex-shrink-0"></i>
                        <span class="sidebar-label truncate pr-2">${session.title || 'Без названия'}</span>
                        <button class="delete-session-btn hidden text-white hover:text-red-400 ml-auto" data-id="${session.id}">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    `;
                    item.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-session-btn')) return;
                        state.activeSessionId = session.id;
                        state.currentView = 'session'; // Переключаемся на вид сессии
                        render();
                    });
                    item.addEventListener('mouseenter', () => item.querySelector('.delete-session-btn').classList.remove('hidden'));
                    item.addEventListener('mouseleave', () => item.querySelector('.delete-session-btn').classList.add('hidden'));
                    
                    sidebarList.appendChild(item);
                });
            } else {
                sidebarList.innerHTML = `<div class="sidebar-label text-center text-sm text-gray-500 p-4">Нет элементов.</div>`;
            }
            lucide.createIcons();
        }

        function renderMainContent() {
            mainContent.innerHTML = '';
            // ИЗМЕНЕНИЕ 4: Логика рендеринга основана на `state.currentView`
            switch (state.currentView) {
                case 'session':
                    const activeSession = state.sessions.find(s => s.id === state.activeSessionId);
                    if (!activeSession) {
                        mainContent.innerHTML = getWelcomeViewHTML();
                        setupWelcomeViewEventListeners();
                    } else if (activeSession.type === 'chat') {
                        mainContent.innerHTML = getChatViewHTML(activeSession);
                        // Автоматический выбор провайдера для нового чата
                        if (!activeSession.providerId && state.providers.length > 0) {
                            const sessionRef = doc(db, `artifacts/${appId}/users/${userId}/sessions`, state.activeSessionId);
                            updateDoc(sessionRef, { providerId: state.providers[0].id });
                        }
                        renderChatMessages(activeSession);
                        setupChatViewEventListeners();
                    } else if (activeSession.type === 'notepad') {
                        mainContent.innerHTML = getNotepadViewHTML(activeSession);
                        setupNotepadViewEventListeners();
                    }
                    break;
                case 'settings':
                    mainContent.innerHTML = getSettingsViewHTML();
                    renderProviders();
                    setupSettingsViewEventListeners();
                    break;
                case 'welcome':
                default:
                    mainContent.innerHTML = getWelcomeViewHTML();
                    setupWelcomeViewEventListeners();
                    break;
            }
            lucide.createIcons();
        }
        
        // --- ШАБЛОНЫ HTML ---
        function getWelcomeViewHTML() {
            return `<div class="flex flex-col h-full items-center justify-center text-center p-8">
                        <i data-lucide="sparkles" class="w-24 h-24 mb-6 text-accent"></i>
                        <h2 class="text-3xl font-bold text-white mb-2">Добро пожаловать в AI Multi-Tool</h2>
                        <p class="text-lg text-text-secondary mb-8 max-w-md">Выберите чат или заметку на панели слева или создайте что-то новое, чтобы начать.</p>
                        <div class="flex space-x-4">
                            <button id="welcome-new-chat-btn" class="flex items-center justify-center bg-accent hover:bg-accent-hover text-white font-bold py-2 px-6 rounded-lg transition-colors">
                                <i data-lucide="message-square-plus" class="w-5 h-5 mr-2"></i>Новый чат
                            </button>
                             <button id="welcome-new-note-btn" class="flex items-center justify-center bg-bg-element hover:bg-bg-input text-white font-bold py-2 px-6 rounded-lg transition-colors">
                                <i data-lucide="notebook-pen" class="w-5 h-5 mr-2"></i>Новая заметка
                            </button>
                        </div>
                    </div>`;
        }
        function getChatViewHTML(activeSession) {
            const providerOptions = state.providers.map(p => `<option value="${p.id}" ${p.id === activeSession.providerId ? 'selected' : ''}>${p.name} (${p.model})</option>`).join('');
            return `
                <div class="flex flex-col h-full">
                    <div class="flex-shrink-0 p-3 border-b border-border-color flex items-center justify-between">
                        <input type="text" id="chat-title-input" class="bg-transparent text-lg font-semibold focus:outline-none focus:ring-1 focus:ring-accent rounded px-2 py-1 w-full" value="${activeSession.title || ''}" placeholder="Название чата">
                        <select id="provider-select" class="bg-input border border-border-color rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-accent ml-4">
                            ${providerOptions.length > 0 ? providerOptions : '<option disabled>Добавьте провайдера в настройках</option>'}
                        </select>
                    </div>
                    <div id="chat-messages" class="flex-grow p-4 overflow-y-auto"></div>
                    <div id="loading-indicator" class="p-4 hidden">
                        <div class="flex items-center space-x-2">
                            <div class="w-10 h-10 rounded-full bg-accent flex items-center justify-center"><i data-lucide="bot" class="w-6 h-6 text-white"></i></div>
                            <div class="typing-indicator"><span></span><span></span><span></span></div>
                        </div>
                    </div>
                    <div class="flex-shrink-0 p-4 border-t border-border-color">
                        <form id="chat-form" class="relative">
                            <textarea id="chat-input" class="w-full bg-input border border-border-color rounded-lg p-3 pr-12 resize-none focus:outline-none focus:ring-2 focus:ring-accent" placeholder="Введите ваше сообщение..." rows="1"></textarea>
                            <button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-full bg-accent hover:bg-accent-hover transition-colors disabled:bg-gray-500"><i data-lucide="send" class="w-5 h-5 text-white"></i></button>
                        </form>
                    </div>
                </div>`;
        }
        function renderChatMessages(session) {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer || !session || !session.messages) { messagesContainer.innerHTML = ''; return; }
            messagesContainer.innerHTML = session.messages.map(msg => {
                const safeContent = msg.content.replace(/</g, "<").replace(/>/g, ">");
                const htmlContent = markdownConverter.makeHtml(safeContent);
                return `
                    <div class="flex items-start space-x-4 mb-6">
                        <div class="w-10 h-10 rounded-full ${msg.role === 'user' ? 'bg-blue-600' : 'bg-accent'} flex-shrink-0 flex items-center justify-center">
                            <i data-lucide="${msg.role === 'user' ? 'user' : 'bot'}" class="w-6 h-6 text-white"></i>
                        </div>
                        <div class="flex-grow prose max-w-full">${htmlContent}</div>
                    </div>`;
            }).join('');
            messagesContainer.querySelectorAll('pre').forEach(preElement => {
                const wrapper = document.createElement('div');
                wrapper.className = 'relative';
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-code-btn';
                copyBtn.innerHTML = '<i data-lucide="copy" class="w-4 h-4"></i>';
                preElement.parentNode.insertBefore(wrapper, preElement);
                wrapper.appendChild(preElement);
                wrapper.appendChild(copyBtn);
            });
            hljs.highlightAll();
            lucide.createIcons();
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        function getNotepadViewHTML(activeSession) {
            return `<div class="flex flex-col h-full p-4">
                        <input type="text" id="note-title-input" class="bg-transparent text-2xl font-bold mb-4 focus:outline-none focus:ring-1 focus:ring-accent rounded px-2 py-1" value="${activeSession.title || ''}" placeholder="Название заметки">
                        <textarea id="note-content-textarea" class="flex-grow w-full bg-input border border-border-color rounded-lg p-4 resize-none focus:outline-none focus:ring-2 focus:ring-accent text-base leading-relaxed" placeholder="Начните писать...">${activeSession.content || ''}</textarea>
                    </div>`;
        }
        function getSettingsViewHTML() { /* без изменений */ return `<div class="p-6"><h2 class="text-2xl font-bold mb-6">Настройки</h2><div class="bg-bg-sidebar p-6 rounded-lg"><h3 class="text-xl font-semibold mb-4">Провайдеры API</h3><div id="providers-list" class="space-y-4 mb-6"></div><div class="border-t border-border-color pt-6"><h4 class="text-lg font-semibold mb-3">Добавить нового провайдера</h4><form id="add-provider-form" class="space-y-3"><input type="text" id="provider-name" placeholder="Название (например, My OpenAI)" class="w-full bg-input p-2 rounded border border-border-color focus:outline-none focus:ring-2 focus:ring-accent" required><input type="text" id="provider-url" placeholder="Базовый URL (например, https://api.openai.com)" class="w-full bg-input p-2 rounded border border-border-color focus:outline-none focus:ring-2 focus:ring-accent" required><input type="text" id="provider-path" placeholder="Путь запроса (например, /v1/chat/completions)" class="w-full bg-input p-2 rounded border border-border-color focus:outline-none focus:ring-2 focus:ring-accent" required><input type="password" id="provider-key" placeholder="API Ключ" class="w-full bg-input p-2 rounded border border-border-color focus:outline-none focus:ring-2 focus:ring-accent" required><input type="text" id="provider-model" placeholder="Название модели (например, gpt-4o)" class="w-full bg-input p-2 rounded border border-border-color focus:outline-none focus:ring-2 focus:ring-accent" required><button type="submit" class="px-4 py-2 bg-accent hover:bg-accent-hover rounded-md transition-colors">Добавить</button></form></div></div></div>`; }
        function renderProviders() { /* без изменений */ const list = document.getElementById('providers-list'); if (!list) return; if (state.providers.length === 0) { list.innerHTML = `<p class="text-text-secondary">Нет добавленных провайдеров.</p>`; return; } list.innerHTML = state.providers.map(p => `<div class="bg-bg-element p-3 rounded-md flex items-center justify-between"><div><p class="font-bold">${p.name}</p><p class="text-sm text-text-secondary">${p.model} • ${p.baseUrl}${p.path}</p></div><button class="delete-provider-btn text-text-secondary hover:text-red-400" data-id="${p.id}"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div>`).join(''); lucide.createIcons(); }
        
        // --- ОБРАБОТЧИКИ СОБЫТИЙ ---
        function setupWelcomeViewEventListeners() {
            document.getElementById('welcome-new-chat-btn')?.addEventListener('click', createNewChat);
            document.getElementById('welcome-new-note-btn')?.addEventListener('click', createNewNote);
        }
        function setupChatViewEventListeners() { /* без существенных изменений */
            const form = document.getElementById('chat-form'); const input = document.getElementById('chat-input'); const titleInput = document.getElementById('chat-title-input'); const providerSelect = document.getElementById('provider-select'); const messagesContainer = document.getElementById('chat-messages');
            form?.addEventListener('submit', handleChatSubmit); input?.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); form.requestSubmit(); } }); input?.addEventListener('input', () => { input.style.height = 'auto'; input.style.height = (input.scrollHeight) + 'px'; });
            titleInput?.addEventListener('change', (e) => { const sessionRef = doc(db, `artifacts/${appId}/users/${userId}/sessions`, state.activeSessionId); updateDoc(sessionRef, { title: e.target.value }); });
            providerSelect?.addEventListener('change', (e) => { const sessionRef = doc(db, `artifacts/${appId}/users/${userId}/sessions`, state.activeSessionId); updateDoc(sessionRef, { providerId: e.target.value }); });
            messagesContainer?.addEventListener('click', e => { const copyBtn = e.target.closest('.copy-code-btn'); if (copyBtn) { const codeElement = copyBtn.parentElement.querySelector('pre code'); if (codeElement) { copyToClipboard(codeElement.innerText); copyBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-green-400"></i>'; lucide.createIcons(); setTimeout(() => { copyBtn.innerHTML = '<i data-lucide="copy" class="w-4 h-4"></i>'; lucide.createIcons(); }, 2000); } } });
        }
        function setupNotepadViewEventListeners() { /* без существенных изменений */
            const titleInput = document.getElementById('note-title-input'); const contentTextarea = document.getElementById('note-content-textarea'); let debounceTimer; const updateNote = () => { const sessionRef = doc(db, `artifacts/${appId}/users/${userId}/sessions`, state.activeSessionId); updateDoc(sessionRef, { title: titleInput.value, content: contentTextarea.value, updatedAt: serverTimestamp() }); }; titleInput?.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(updateNote, 500); }); contentTextarea?.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(updateNote, 500); });
        }
        function setupSettingsViewEventListeners() { document.getElementById('add-provider-form')?.addEventListener('submit', handleAddProvider); }
        
        // --- ЛОГИКА ---
        async function createNewChat() {
            const newSessionRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/sessions`), {
                type: 'chat', title: 'Новый чат', messages: [], providerId: state.providers.length > 0 ? state.providers[0].id : null,
                createdAt: serverTimestamp(), updatedAt: serverTimestamp()
            });
            state.activeSessionId = newSessionRef.id;
            state.currentView = 'session';
            render();
        }
        async function createNewNote() {
            const newSessionRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/sessions`), {
                type: 'notepad', title: 'Новая заметка', content: '',
                createdAt: serverTimestamp(), updatedAt: serverTimestamp()
            });
            state.activeSessionId = newSessionRef.id;
            state.currentView = 'session';
            render();
        }
        async function handleChatSubmit(e) { /* без изменений */ e.preventDefault(); const input = document.getElementById('chat-input'); const message = input.value.trim(); if (!message || state.isLoading) return; const sessionRef = doc(db, `artifacts/${appId}/users/${userId}/sessions`, state.activeSessionId); const activeSession = state.sessions.find(s => s.id === state.activeSessionId); const provider = state.providers.find(p => p.id === activeSession.providerId); if (!provider) { showModalAlert("Пожалуйста, выберите или добавьте провайдера API в настройках."); return; } const newMessages = [...(activeSession.messages || []), { role: 'user', content: message }]; await updateDoc(sessionRef, { messages: newMessages, updatedAt: serverTimestamp() }); input.value = ''; input.style.height = 'auto'; state.isLoading = true; updateLoadingIndicator(); try { const fullUrl = new URL(provider.path, provider.baseUrl).href; const apiMessages = newMessages.map(m => ({ role: m.role, content: m.content })); const response = await fetch(fullUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${provider.apiKey}` }, body: JSON.stringify({ model: provider.model, messages: apiMessages }) }); if (!response.ok) { const errorData = await response.json(); throw new Error(`API Error: ${errorData.error?.message || response.statusText}`); } const data = await response.json(); const assistantMessage = data.choices[0].message.content; await updateDoc(sessionRef, { messages: [...newMessages, { role: 'assistant', content: assistantMessage }] }); } catch (error) { console.error("Error calling LLM API:", error); await updateDoc(sessionRef, { messages: [...newMessages, { role: 'assistant', content: `**Ошибка:** ${error.message}` }] }); } finally { state.isLoading = false; updateLoadingIndicator(); } }
        function updateLoadingIndicator() { /* без изменений */ const indicator = document.getElementById('loading-indicator'); const form = document.getElementById('chat-form'); if (indicator) { indicator.classList.toggle('hidden', !state.isLoading); if (!state.isLoading) { const messagesContainer = document.getElementById('chat-messages'); if(messagesContainer) messagesContainer.scrollTop = messagesContainer.scrollHeight; } } if (form) { form.querySelector('button').disabled = state.isLoading; form.querySelector('textarea').disabled = state.isLoading; } }
        async function handleAddProvider(e) { /* без изменений */ e.preventDefault(); const name = document.getElementById('provider-name').value; const baseUrl = document.getElementById('provider-url').value; const path = document.getElementById('provider-path').value; const apiKey = document.getElementById('provider-key').value; const model = document.getElementById('provider-model').value; await addDoc(collection(db, `artifacts/${appId}/users/${userId}/providers`), { name, baseUrl, path, apiKey, model }); e.target.reset(); }
        function copyToClipboard(text) { /* без изменений */ navigator.clipboard.writeText(text).catch(err => console.error('Не удалось скопировать текст: ', err)); }
        function showConfirmModal(message, onConfirm) { /* без изменений */ confirmModalText.textContent = message; confirmModalCallback = onConfirm; confirmModal.classList.remove('hidden'); }
        function hideConfirmModal() { /* без изменений */ confirmModal.classList.add('hidden'); confirmModalCallback = null; }
        function showModalAlert(message) { /* без изменений */ confirmModalText.textContent = message; confirmModalYesBtn.classList.add('hidden'); confirmModalNoBtn.textContent = 'OK'; confirmModal.classList.remove('hidden'); confirmModalCallback = () => { confirmModalYesBtn.classList.remove('hidden'); confirmModalNoBtn.textContent = 'Нет'; }; }

        // --- ГЛАВНЫЕ ОБРАБОТЧИКИ И ИНИЦИАЛИЗАЦИЯ ---
        function setupGlobalEventListeners() {
            // ИЗМЕНЕНИЕ 5: Новые обработчики для кнопок создания, настроек и сворачивания
            document.getElementById('sidebar-toggle-btn')?.addEventListener('click', () => {
                state.isSidebarCollapsed = !state.isSidebarCollapsed;
                renderSidebar();
            });
            document.getElementById('new-chat-btn')?.addEventListener('click', createNewChat);
            document.getElementById('new-note-btn')?.addEventListener('click', createNewNote);
            document.getElementById('settings-btn')?.addEventListener('click', () => {
                state.currentView = 'settings';
                state.activeSessionId = null; // Сбрасываем активную сессию при переходе в настройки
                render();
            });

            document.body.addEventListener('click', async (e) => {
                const deleteSessionBtn = e.target.closest('.delete-session-btn');
                if (deleteSessionBtn) {
                    const idToDelete = deleteSessionBtn.dataset.id;
                    showConfirmModal('Вы уверены, что хотите удалить этот элемент?', async () => {
                        await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/sessions`, idToDelete));
                        // Если удалили активный элемент, переключаемся на welcome view
                        if (state.activeSessionId === idToDelete) { 
                            state.activeSessionId = null; 
                            state.currentView = 'welcome';
                        }
                    });
                }
                const deleteProviderBtn = e.target.closest('.delete-provider-btn');
                if (deleteProviderBtn) {
                    const idToDelete = deleteProviderBtn.dataset.id;
                    showConfirmModal('Вы уверены, что хотите удалить этого провайдера?', async () => {
                        await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/providers`, idToDelete));
                    });
                }
            });
            
            confirmModalYesBtn.addEventListener('click', () => { if (confirmModalCallback) { confirmModalCallback(); } hideConfirmModal(); });
            confirmModalNoBtn.addEventListener('click', () => { if(confirmModalNoBtn.textContent === 'OK') { if (confirmModalCallback) confirmModalCallback(); } hideConfirmModal(); });
            
            document.getElementById('google-signin-btn')?.addEventListener('click', async () => {
                try { const provider = new GoogleAuthProvider(); await signInWithPopup(auth, provider); } 
                catch (error) { console.error("Google sign-in error", error); showModalAlert("Не удалось войти через Google. Ошибка: " + error.message); }
            });

            document.getElementById('sign-out-btn')?.addEventListener('click', async (e) => {
                e.preventDefault();
                try { await signOut(auth); } 
                catch (error) { console.error("Sign-out error", error); }
            });
        }
        
        function attachFirestoreListeners() {
            unsubscribeSessions(); unsubscribeProviders();
            const sessionsCol = collection(db, `artifacts/${appId}/users/${userId}/sessions`);
            unsubscribeSessions = onSnapshot(sessionsCol, (snapshot) => {
                state.sessions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                             .sort((a,b) => (b.updatedAt?.toMillis() || 0) - (a.updatedAt?.toMillis() || 0));
                
                // Проверяем, существует ли активная сессия. Если нет - сбрасываем вид
                const activeSessionExists = state.sessions.some(s => s.id === state.activeSessionId);
                if (!activeSessionExists && state.currentView === 'session') {
                    state.activeSessionId = null;
                    state.currentView = 'welcome';
                }
                render();
            }, error => console.error("Session listener error: ", error));

            const providersCol = collection(db, `artifacts/${appId}/users/${userId}/providers`);
            unsubscribeProviders = onSnapshot(providersCol, (snapshot) => {
                state.providers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.currentView === 'settings' || state.currentView === 'session') {
                    render();
                }
            }, error => console.error("Providers listener error: ", error));
        }

        function resetState() {
            unsubscribeSessions(); unsubscribeProviders();
            state = { currentView: 'welcome', activeSessionId: null, sessions: [], providers: [], isLoading: false, isAuthReady: false, isSidebarCollapsed: false };
            sidebarList.innerHTML = '<div class="p-4 text-center text-gray-500">Пожалуйста, войдите.</div>';
            mainContent.innerHTML = getWelcomeViewHTML();
            lucide.createIcons();
        }

        async function init() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    const googleBtn = document.getElementById('google-signin-btn');
                    const userProfile = document.getElementById('user-profile');
                    const authSection = document.getElementById('auth-section');
                    authSection.classList.remove('hidden');

                    if (user) {
                        userId = user.uid;
                        state.isAuthReady = true;

                        googleBtn.classList.add('hidden');
                        userProfile.classList.remove('hidden');

                        document.getElementById('user-name').textContent = user.displayName || 'Пользователь';
                        document.getElementById('user-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'A'}&background=random`;
                        
                        attachFirestoreListeners();
                        // Устанавливаем начальное состояние после входа
                        if (!state.activeSessionId && state.sessions.length > 0) {
                            state.activeSessionId = state.sessions[0].id;
                            state.currentView = 'session';
                        } else {
                            state.currentView = 'welcome';
                        }
                        render();
                    } else {
                        userId = null;
                        state.isAuthReady = false;

                        googleBtn.classList.remove('hidden');
                        userProfile.classList.add('hidden');
                        
                        resetState();
                    }
                });
                
                setupGlobalEventListeners();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                mainContent.innerHTML = `<div class="p-4 text-red-400"><strong>Ошибка инициализации Firebase:</strong> ${error.message}.</div>`;
            }
        }
        
        init();

    </script>

    <!-- ИЗМЕНЕНИЕ 6: Обновленная структура Sidebar -->
    <aside id="sidebar" class="w-1/4 max-w-xs bg-bg-sidebar flex flex-col h-full border-r border-border-color sidebar-transition flex-shrink-0">
        <div id="sidebar-header" class="p-2 border-b border-border-color flex justify-between items-center h-[61px]">
             <button id="sidebar-toggle-btn" class="icon-btn ml-2">
                <i data-lucide="panel-left-close" class="w-5 h-5"></i>
            </button>
            <div class="sidebar-label flex items-center space-x-2">
                 <button id="new-chat-btn" title="Новый чат" class="icon-btn">
                    <i data-lucide="message-square-plus" class="w-5 h-5"></i>
                </button>
                 <button id="new-note-btn" title="Новая заметка" class="icon-btn">
                    <i data-lucide="notebook-pen" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
        
        <nav id="sidebar-list" class="flex-grow overflow-y-auto p-2">
            <!-- Список чатов/заметок -->
        </nav>
        
        <div id="auth-section" class="p-3 border-t border-border-color flex items-center hidden">
            <button id="google-signin-btn" class="w-full flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded transition-colors text-sm">
                <svg class="w-4 h-4 mr-2" viewBox="0 0 48 48" fill="currentColor"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                <span class="sidebar-label">Войти через Google</span>
            </button>
            
            <div id="user-profile" class="hidden w-full flex items-center text-left">
                <img id="user-avatar" class="w-9 h-9 rounded-full mr-2 flex-shrink-0">
                <div id="user-profile-details" class="text-xs overflow-hidden flex-grow">
                    <p id="user-name" class="font-semibold text-text-primary truncate"></p>
                    <a href="#" id="sign-out-btn" class="text-red-400 hover:text-red-500">Выйти</a>
                </div>
                <button id="settings-btn" title="Настройки" class="icon-btn ml-auto">
                    <i data-lucide="cog" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- ИЗМЕНЕНИЕ 7: Основной блок теперь не имеет фиксированной ширины, а занимает оставшееся место -->
    <main class="flex-grow flex flex-col h-full">
         <!-- Навигационная панель убрана -->
        <div id="main-content" class="flex-grow overflow-y-auto">
            <!-- Содержимое вкладок -->
        </div>
    </main>
    
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <p id="confirm-modal-text" class="text-text-primary mb-6 text-center">Вы уверены?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-modal-no" class="px-6 py-2 rounded-md bg-bg-input hover:bg-gray-600 transition-colors">Нет</button>
                <button id="confirm-modal-yes" class="px-6 py-2 rounded-md bg-danger hover:bg-danger-hover text-white transition-colors">Да</button>
            </div>
        </div>
    </div>

</body>
</html>
