<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Multi-Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* --- НОВАЯ СОВРЕМЕННАЯ ПАЛИТРА И СТИЛИ --- */
        :root {
            --bg-main-start: #1a1c23;
            --bg-main-end: #121417;
            --bg-sidebar: rgba(30, 32, 40, 0.7); /* Полупрозрачный для эффекта стекла */
            --bg-element: rgba(45, 48, 58, 0.7);
            --bg-input: rgba(30, 32, 40, 0.9);
            --text-primary: #e0e0e0;
            --text-secondary: #8a91a0;
            --accent-start: #007cf0;
            --accent-end: #00dfd8;
            --accent-gradient: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            --border-color: rgba(69, 73, 86, 0.5);
            --danger: #e53e3e;
            --danger-hover: #c53030;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main-start);
            background-image: linear-gradient(180deg, var(--bg-main-start), var(--bg-main-end));
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        input, textarea, select {
            color: var(--text-primary);
            transition: all 0.2s ease-in-out;
        }

        input::placeholder, textarea::placeholder {
            color: var(--text-secondary);
        }

        .bg-input {
            background-color: var(--bg-input);
        }

        /* Эффект матового стекла */
        .glassmorphism {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
        }
        
        #sidebar {
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
            width: 280px;
            flex-shrink: 0;
            background-color: var(--bg-sidebar);
            border-right-color: var(--border-color);
        }
        
        @media (max-width: 1023px) {
            #sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100%;
                z-index: 40;
                transform: translateX(-100%);
                /* Применяем эффект стекла на мобильных */
                background-color: var(--bg-sidebar);
            }
            #sidebar.open {
                transform: translateX(0);
                box-shadow: 0 0 40px var(--shadow-color);
            }
        }

        @media (min-width: 1024px) {
            #sidebar {
                 background-color: var(--bg-main-start); /* Непрозрачный на десктопе */
            }
            #sidebar.collapsed {
                width: 0;
                padding-left: 0;
                padding-right: 0;
                overflow: hidden;
            }
        }
        
        .sidebar-item {
            border-left: 3px solid transparent;
            transition: background-color 0.2s, border-left-color 0.2s;
        }
        .sidebar-item.active { 
            background-color: var(--bg-element);
            border-left-color: var(--accent-start);
            color: white; 
        }
        .sidebar-item:hover { 
            background-color: rgba(255, 255, 255, 0.05);
        }

        .main-nav-item.active { 
            border-bottom: 2px solid var(--accent-start);
            color: white; 
        }
        .main-nav-item {
            transition: color 0.2s, border-bottom-color 0.2s;
        }
        
        /* Улучшенные кнопки */
        #new-chat-btn, #new-note-btn {
            background-image: var(--accent-gradient);
            background-size: 200% auto;
            transition: background-position 0.3s, transform 0.2s;
        }
        #new-chat-btn:hover, #new-note-btn:hover {
            background-position: right center;
            transform: scale(1.03);
        }
        
        /* Скроллбар */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; border: 2px solid transparent; background-clip: content-box;}
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-start); }
        
        /* Анимация печати */
        .typing-indicator span { height: 8px; width: 8px; background-image: var(--accent-gradient); border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        
        /* Стилизация контента */
        .prose { color: var(--text-primary); }
        .prose h1, .prose h2, .prose h3 { color: white; border-bottom: 1px solid var(--border-color); }
        .prose a { color: var(--accent-start); transition: color 0.2s; }
        .prose a:hover { color: var(--accent-end); }
        .prose pre { background-color: rgba(0,0,0,0.3); padding: 1rem; border-radius: 0.5rem; position: relative; margin-top: 1.25em; margin-bottom: 1.25em; border: 1px solid var(--border-color); }
        .prose code { background-color: var(--bg-element); padding: 0.2rem 0.4rem; border-radius: 0.3rem; font-family: 'Courier New', Courier, monospace; }
        .prose pre code { background-color: transparent; padding: 0; border-radius: 0; }
        .prose blockquote { border-left-color: var(--accent-start); }
        .copy-code-btn { position: absolute; top: 0.5rem; right: 0.5rem; background-color: var(--bg-element); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 0.3rem; padding: 0.25rem; opacity: 0.5; transition: all 0.2s; }
        .prose pre:hover .copy-code-btn { opacity: 1; }
        .copy-code-btn:hover { background-color: var(--bg-input); color: var(--text-primary); transform: scale(1.1); }
        .prose pre {
            background-color: rgba(0,0,0,0.3);
            padding: 1rem;
            border-radius: 0.5rem;
            position: relative;
            margin-top: 1.25em;
            margin-bottom: 1.25em;
            border: 1px solid var(--border-color);
            
            /* КЛЮЧЕВОЕ СВОЙСТВО: Сохраняет все пробелы, отступы и переносы */
            white-space: pre-wrap; 
            
            /* Ломает слова, которые не помещаются в блок. Важно для длинных строк без пробелов. */
            word-wrap: break-word; 
        }
        
        .prose pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
            
            /* Сбрасываем лишние стили для кода внутри блока <pre> */
            white-space: inherit; /* Наследуем white-space от родителя <pre> */
            word-wrap: inherit;   /* Наследуем word-wrap от родителя <pre> */
        }
        
        /* Это правило для `code` вне блоков `pre` (inline-code) */
        .prose code { 
          background-color: var(--bg-element); 
          padding: 0.2rem 0.4rem; 
          border-radius: 0.3rem; 
          font-family: 'Courier New', Courier, monospace;
          /* Для inline-кода не нужно сохранять переносы, поэтому white-space не указываем */
        }

        .user-message-content {
            white-space: pre-wrap; /* Главное свойство: сохраняет все пробелы и переносы */
            word-wrap: break-word;   /* Переносит длинные строки, которые не помещаются */
            color: inherit;        /* Наследует цвет текста от родительского "пузыря" */
        }
        
        /* Модальные окна со стеклянным эффектом */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
        .modal-content { background-color: var(--bg-sidebar); padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 400px; box-shadow: 0 10px 35px var(--shadow-color); border: 1px solid var(--border-color); }
        
        /* Улучшенные поля ввода */
        input[type="text"], input[type="email"], textarea, select {
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }
        input[type="text"]:focus, input[type="email"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-start);
            box-shadow: 0 0 0 2px rgba(0, 124, 240, 0.3);
        }
        
        /* Кнопка отправки сообщения */
        #chat-form button[type="submit"] {
             background-image: var(--accent-gradient);
             background-size: 200% auto;
             transition: all 0.3s;
        }
        #chat-form button[type="submit"]:hover {
             background-position: right center;
             transform: scale(1.1);
        }
        #chat-form button[type="submit"]:disabled {
            background-image: none;
            background-color: var(--bg-element);
            cursor: not-allowed;
            transform: scale(1);
        }
    </style>
</head>
<body class="h-dvh w-full flex">

    <div id="sidebar-backdrop" class="fixed inset-0 bg-black/60 z-30 hidden lg:hidden"></div>

    <!-- Боковая панель теперь будет использовать эффект стекла на мобильных -->
    <aside id="sidebar" class="flex flex-col h-full border-r">
        <div class="p-4 border-b border-border-color flex justify-between items-center flex-shrink-0">
            <h1 class="text-xl font-bold flex items-center"><i data-lucide="sparkles" class="w-6 h-6 mr-2 text-accent-start"></i>AI Multi-Tool</h1>
        </div>
        <div class="p-2 flex-shrink-0">
            <button id="new-chat-btn" class="w-full flex items-center justify-center text-white font-bold py-2 px-4 rounded-md transition-colors">
                <i data-lucide="plus" class="w-5 h-5 mr-2"></i>Новый чат
            </button>
             <button id="new-note-btn" class="w-full flex items-center justify-center text-white font-bold py-2 px-4 rounded-md transition-colors hidden">
                <i data-lucide="plus" class="w-5 h-5 mr-2"></i>Новая заметка
            </button>
        </div>
        <nav id="sidebar-list" class="flex-grow overflow-y-auto p-2">
        </nav>
        <div id="auth-section" class="p-3 border-t border-border-color text-center hidden">
            <button id="google-signin-btn" class="w-full flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-md transition-colors text-sm">
                <svg class="w-4 h-4 mr-2" viewBox="0 0 48 48" fill="currentColor"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                Войти через Google
            </button>
            <div id="user-profile" class="hidden flex items-center text-left">
                <img id="user-avatar" class="w-8 h-8 rounded-full mr-2 flex-shrink-0">
                <div class="text-xs overflow-hidden">
                    <p id="user-name" class="font-semibold text-text-primary truncate"></p>
                    <a href="#" id="sign-out-btn" class="text-red-400 hover:text-red-500">Выйти</a>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-grow flex flex-col h-full w-full">
        <nav class="flex-shrink-0 border-b border-border-color flex items-center bg-bg-main-start/50">
            <button id="sidebar-toggle-btn" class="p-3 hover:bg-bg-element transition-colors border-r border-border-color">
                <i id="sidebar-toggle-icon" data-lucide="panel-left-close" class="w-5 h-5"></i>
            </button>
            <div class="flex space-x-4 px-4">
                <button data-tab="chat" class="main-nav-item py-3 px-2 text-text-secondary hover:text-white active">Чат</button>
                <button data-tab="notepad" class="main-nav-item py-3 px-2 text-text-secondary hover:text-white">Блокнот</button>
                <button data-tab="roles" class="main-nav-item py-3 px-2 text-text-secondary hover:text-white">Роли</button>
                <button data-tab="settings" class="main-nav-item py-3 px-2 text-text-secondary hover:text-white">Настройки</button>
            </div>
        </nav>
        <div id="main-content" class="flex-grow overflow-y-auto">
        </div>
    </main>
    
    <!-- Модальные окна с эффектом стекла -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <p id="confirm-modal-text" class="text-text-primary mb-6 text-center">Вы уверены?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-modal-no" class="px-6 py-2 rounded-md bg-bg-input hover:bg-gray-600 transition-colors">Нет</button>
                <button id="confirm-modal-yes" class="px-6 py-2 rounded-md bg-danger hover:bg-danger-hover text-white transition-colors">Да</button>
            </div>
        </div>
    </div>
    
    <div id="edit-provider-modal" class="modal-overlay hidden">
        <div class="modal-content !max-w-xl">
            <h3 class="text-xl font-semibold mb-4">Редактировать провайдера</h3>
            <form id="edit-provider-form" class="space-y-3">
                <input type="hidden" id="edit-provider-id">
                <div>
                    <label for="edit-provider-name" class="text-sm text-text-secondary block mb-1">Название</label>
                    <input type="text" id="edit-provider-name" class="w-full p-2" required>
                </div>
                <div>
                    <label for="edit-provider-url" class="text-sm text-text-secondary block mb-1">Базовый URL</label>
                    <input type="text" id="edit-provider-url" class="w-full p-2" required>
                </div>
                 <div>
                    <label for="edit-provider-path" class="text-sm text-text-secondary block mb-1">Путь запроса</label>
                    <input type="text" id="edit-provider-path" class="w-full p-2" required>
                </div>
                <div>
                    <label for="edit-provider-keys" class="text-sm text-text-secondary block mb-1">API Ключи (каждый с новой строки)</label>
                    <textarea id="edit-provider-keys" class="w-full p-2" rows="4" required></textarea>
                </div>
                <div>
                    <label for="edit-provider-model" class="text-sm text-text-secondary block mb-1">Название модели</label>
                    <input type="text" id="edit-provider-model" class="w-full p-2" required>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="edit-provider-cancel-btn" class="px-4 py-2 rounded-md bg-bg-input hover:bg-gray-600 transition-colors">Отмена</button>
                    <button type="submit" class="px-4 py-2 rounded-md bg-accent-start hover:bg-accent-end text-white transition-colors">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-role-modal" class="modal-overlay hidden">
        <div class="modal-content !max-w-xl">
            <h3 class="text-xl font-semibold mb-4">Редактировать роль</h3>
            <form id="edit-role-form" class="space-y-3">
                <input type="hidden" id="edit-role-id">
                <div>
                    <label for="edit-role-name" class="text-sm text-text-secondary block mb-1">Название роли</label>
                    <input type="text" id="edit-role-name" class="w-full p-2" required>
                </div>
                <div>
                    <label for="edit-role-content" class="text-sm text-text-secondary block mb-1">Содержимое роли (Системный промпт)</label>
                    <textarea id="edit-role-content" class="w-full p-2" rows="8" required></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="edit-role-cancel-btn" class="px-4 py-2 rounded-md bg-bg-input hover:bg-gray-600 transition-colors">Отмена</button>
                    <button type="submit" class="px-4 py-2 rounded-md bg-accent-start hover:bg-accent-end text-white transition-colors">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <!-- СКРИПТЫ ОСТАЮТСЯ БЕЗ ИЗМЕНЕНИЙ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, setDoc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
        // --- ГЛОБАЛЬНОЕ СОСТОЯНИЕ И КОНФИГУРАЦИЯ ---
        const firebaseConfig = {
            apiKey: "AIzaSyDZ3u9scjk3dydutXO0EUrWlpUnsp4OuqA",
            authDomain: "appllm.firebaseapp.com",
            projectId: "appllm",
            storageBucket: "appllm.appspot.com",
            messagingSenderId: "926733538345",
            appId: "1:926733538345:web:dac990973b29ca574ff938",
            measurementId: "G-YX6FY680C9"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
        let db, auth, userId;
        let unsubscribeSessions = () => {};
        let unsubscribeProviders = () => {};
        let unsubscribeRoles = () => {};
    
        let state = {
            activeTab: 'chat',
            activeSessionId: null,
            sessions: [],
            providers: [],
            roles: [],
            isLoading: false,
            isAuthReady: false,
            isSidebarCollapsed: window.innerWidth >= 1024,
        };
        
        let confirmModalCallback = null;
        const markdownConverter = new showdown.Converter({
            tables: true,
            strikethrough: true,
            tasklists: true,
            openLinksInNewWindow: true,
            ghCompatibleHeaderId: true,
            simpleLineBreaks: true
        });
        
        const sidebar = document.getElementById('sidebar');
        const sidebarList = document.getElementById('sidebar-list');
        const mainContent = document.getElementById('main-content');
        const mainNavItems = document.querySelectorAll('.main-nav-item');
        const newChatBtn = document.getElementById('new-chat-btn');
        const newNoteBtn = document.getElementById('new-note-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmModalYesBtn = document.getElementById('confirm-modal-yes');
        const confirmModalNoBtn = document.getElementById('confirm-modal-no');
        const sidebarBackdrop = document.getElementById('sidebar-backdrop');
        const editProviderModal = document.getElementById('edit-provider-modal');
        const editProviderForm = document.getElementById('edit-provider-form');
        const editProviderCancelBtn = document.getElementById('edit-provider-cancel-btn');
        const editRoleModal = document.getElementById('edit-role-modal');
        const editRoleForm = document.getElementById('edit-role-form');
        const editRoleCancelBtn = document.getElementById('edit-role-cancel-btn');
    
        // --- РАБОЧИЕ ФУНКЦИИ БЕЗ ОШИБОК ---
        
        function updateSidebarView() {
            const sidebar = document.getElementById('sidebar');
            const toggleIcon = document.getElementById('sidebar-toggle-icon');
            if (!sidebar || !toggleIcon) return;
            const isMobile = window.innerWidth < 1024;
            if (isMobile) {
                sidebar.classList.remove('collapsed');
                toggleIcon.setAttribute('data-lucide', 'menu');
            } else {
                sidebar.classList.toggle('collapsed', state.isSidebarCollapsed);
                toggleIcon.setAttribute('data-lucide', state.isSidebarCollapsed ? 'panel-left-open' : 'panel-left-close');
            }
            lucide.createIcons();
        }

        function preprocessTextForIndents(text) {
            if (!text) return '';
            const lines = text.split('\n');
            let inCodeBlock = false;
            const processedLines = lines.map(line => {
                if (line.trim().startsWith('```')) {
                    inCodeBlock = !inCodeBlock;
                    return line;
                }
                if (inCodeBlock) {
                    return line;
                }
                const match = line.match(/^(\s+)/);
                if (match) {
                    const leadingSpaces = match;
                    const nonBreakingSpaces = ' '.repeat(leadingSpaces.length);
                    return nonBreakingSpaces + line.substring(leadingSpaces.length);
                }
                return line;
            });
            return processedLines.join('\n');
        }

        function render() {
            if (!state.isAuthReady) return;
            renderSidebar();
            renderMainContent();
            renderMainNav();
        }
    
        function renderSidebar() {
            sidebarList.innerHTML = '';
            const filteredSessions = state.sessions.filter(s => s.type === state.activeTab);
    
            if (filteredSessions.length > 0) {
                filteredSessions.forEach(session => {
                    const item = document.createElement('div');
                    item.className = `sidebar-item flex justify-between items-center p-2 my-1 rounded-md cursor-pointer duration-200 ${session.id === state.activeSessionId ? 'active' : ''}`;
                    item.innerHTML = `<span class="truncate pr-2">${session.title || 'Без названия'}</span><button class="delete-session-btn hidden text-white hover:text-red-400" data-id="${session.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                    item.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-session-btn')) return;
                        state.activeSessionId = session.id;
                        render(); 
                        if (window.innerWidth < 1024) {
                           sidebar.classList.remove('open');
                           sidebarBackdrop.classList.add('hidden');
                        }
                    });
                    item.addEventListener('mouseenter', () => item.querySelector('.delete-session-btn').classList.remove('hidden'));
                    item.addEventListener('mouseleave', () => item.querySelector('.delete-session-btn').classList.add('hidden'));
                    sidebarList.appendChild(item);
                });
            } else if (state.activeTab === 'chat' || state.activeTab === 'notepad') {
                 sidebarList.innerHTML = `<div class="text-center text-sm text-gray-500 p-4">Нет ${state.activeTab === 'chat' ? 'чатов' : 'заметок'}.</div>`;
            } else {
                 sidebarList.innerHTML = ''; 
            }
            lucide.createIcons();
        }
    
        function renderMainContent() {
            mainContent.innerHTML = '';
            const activeSession = state.sessions.find(s => s.id === state.activeSessionId);
            switch (state.activeTab) {
                case 'chat':
                    activeSession ? (mainContent.innerHTML = getChatViewHTML(activeSession), renderChatMessages(activeSession), setupChatViewEventListeners(), updateLoadingIndicator()) : (mainContent.innerHTML = getEmptyStateHTML('chat'));
                    break;
                case 'notepad':
                    activeSession ? (mainContent.innerHTML = getNotepadViewHTML(activeSession), setupNotepadViewEventListeners()) : (mainContent.innerHTML = getEmptyStateHTML('notepad'));
                    break;
                case 'roles': 
                    mainContent.innerHTML = getRolesViewHTML(); renderRoles(); setupRolesViewEventListeners();
                    break;
                case 'settings':
                    mainContent.innerHTML = getSettingsViewHTML(); renderProviders(); setupSettingsViewEventListeners();
                    break;
            }
            lucide.createIcons();
        }
        
        function renderMainNav() {
            mainNavItems.forEach(item => item.classList.toggle('active', item.dataset.tab === state.activeTab));
            newChatBtn.classList.toggle('hidden', state.activeTab !== 'chat');
            newNoteBtn.classList.toggle('hidden', state.activeTab !== 'notepad');
        }
    
        function getEmptyStateHTML(type) { const i = type === 'chat' ? 'message-square' : 'notebook', t = type === 'chat' ? 'Выберите чат или создайте новый' : 'Выберите заметку или создайте новую'; return `<div class="flex flex-col h-full items-center justify-center text-gray-500 text-center p-4"><i data-lucide="${i}" class="w-16 h-16 mb-4"></i><h2 class="text-2xl">${t}</h2></div>`; }
        
        function getChatViewHTML(activeSession) { 
            const pOpts = state.providers.map(p => `<option value="${p.id}" ${p.id === activeSession.providerId ? 'selected' : ''}>${p.name} (${p.model})</option>`).join('');
            const rOpts = state.roles.map(r => `<option value="${r.id}" ${r.id === activeSession.roleId ? 'selected' : ''}>${r.name}</option>`).join('');
            return `<div class="flex flex-col h-full"><div class="flex-shrink-0 p-3 border-b border-border-color flex flex-col sm:flex-row items-center justify-between gap-3"><input type="text" id="chat-title-input" class="bg-transparent text-lg font-semibold focus:outline-none focus:ring-1 focus:ring-accent-start rounded px-2 py-1 w-full sm:flex-1" value="${activeSession.title || ''}" placeholder="Название чата"><div class="flex items-center gap-2 w-full sm:w-auto flex-shrink-0"><select id="role-select" class="bg-input p-2 text-sm w-full sm:w-auto"><option value="">Без роли</option>${rOpts}</select><select id="provider-select" class="bg-input p-2 text-sm w-full sm:w-auto">${pOpts.length > 0 ? pOpts : '<option disabled>Добавьте провайдера</option>'}</select></div></div><div id="chat-messages" class="flex-grow p-4 overflow-y-auto"></div><div class="flex-shrink-0 p-4 border-t border-border-color"><form id="chat-form" class="relative"><textarea id="chat-input" class="w-full bg-input p-3 pr-12 resize-none" placeholder="Введите ваше сообщение..." rows="1"></textarea><button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 rounded-full disabled:bg-gray-500"><i data-lucide="send" class="w-5 h-5 text-white"></i></button></form></div></div>`; 
        }
        
        function renderChatMessages(session) {
            const messagesContainer = document.getElementById('chat-messages');
            if (!messagesContainer || !session || !session.messages) { if (messagesContainer) messagesContainer.innerHTML = ''; return; }
            messagesContainer.innerHTML = session.messages.map((msg, index) => {
                const isUser = msg.role === 'user', safeContent = msg.content || '', icon = isUser ? 'user' : 'sparkles';
                let htmlContent;
                if (isUser) { htmlContent = `<div class="user-message-content">${safeContent.replace(/</g, "<").replace(/>/g, ">")}</div>`; } 
                else { htmlContent = markdownConverter.makeHtml(preprocessTextForIndents(safeContent)); }
                const wrapperFlex = isUser ? 'justify-end' : 'justify-start', containerFlex = isUser ? 'flex-row-reverse' : '', bubble = isUser ? 'bg-accent-start text-white prose-invert' : 'bg-bg-element', delBtnPos = isUser ? 'left-0 -translate-x-full pr-2' : 'right-0 translate-x-full pl-2';
                return `<div class="message-wrapper w-full flex ${wrapperFlex} mb-4"><div class="message-container flex items-start gap-x-3 max-w-[85%] group relative ${containerFlex}"><div class="w-10 h-10 rounded-full ${isUser ? 'bg-blue-600' : 'bg-gradient-to-br from-accent-start to-accent-end'} flex-shrink-0 flex items-center justify-center shadow-md"><i data-lucide="${icon}" class="w-6 h-6 text-white"></i></div><div class="flex-grow prose max-w-full ${bubble} rounded-xl px-4 py-2 shadow-sm">${htmlContent}</div><button class="delete-message-btn absolute top-1/2 -translate-y-1/2 ${delBtnPos} p-1 text-text-secondary hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all" data-message-index="${index}"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`;
            }).join('');
            messagesContainer.querySelectorAll('pre').forEach(pre => { const w = document.createElement('div'); w.className = 'relative'; const c = document.createElement('button'); c.className = 'copy-code-btn'; c.innerHTML = '<i data-lucide="copy" class="w-4 h-4"></i>'; pre.parentNode.insertBefore(w, pre); w.appendChild(pre); w.appendChild(c); });
            hljs.highlightAll(); lucide.createIcons();
            if(!state.isLoading) { messagesContainer.scrollTop = messagesContainer.scrollHeight; }
        }
    
        function getNotepadViewHTML(s) { return `<div class="flex flex-col h-full p-4"><input type="text" id="note-title-input" class="bg-transparent text-2xl font-bold mb-4 focus:outline-none focus:ring-1 focus:ring-accent-start rounded px-2 py-1" value="${s.title || ''}" placeholder="Название заметки"><textarea id="note-content-textarea" class="flex-grow w-full bg-input p-4 resize-none text-base leading-relaxed" placeholder="Начните писать...">${s.content || ''}</textarea></div>`; }
        function getRolesViewHTML() { return `<div class="p-6"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Управление ролями</h2><button id="add-new-role-btn" class="flex items-center px-4 py-2 bg-accent-start hover:bg-accent-end rounded-md transition-colors"><i data-lucide="plus" class="w-5 h-5 mr-2"></i>Добавить роль</button></div><div class="bg-bg-element/50 p-6 rounded-lg glassmorphism"><div id="roles-list" class="space-y-4"></div></div></div>`; }
        function renderRoles() { const l = document.getElementById('roles-list'); if (!l) return; if (state.roles.length === 0) { l.innerHTML = `<p class="text-text-secondary">Нет ролей.</p>`; return; } l.innerHTML = state.roles.map(r => `<div class="bg-bg-element p-3 rounded-md"><div class="flex items-center justify-between mb-2"><p class="font-bold">${r.name}</p><div class="flex items-center space-x-2"><button class="edit-role-btn text-text-secondary hover:text-accent-start" data-id="${r.id}"><i data-lucide="edit" class="w-5 h-5"></i></button><button class="delete-role-btn text-text-secondary hover:text-red-400" data-id="${r.id}"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div></div><p class="text-sm text-text-secondary bg-bg-input p-2 rounded truncate">${r.content}</p></div>`).join(''); lucide.createIcons(); }
        function getSettingsViewHTML() { return `<div class="p-6"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Настройки</h2><button id="add-new-provider-btn" class="flex items-center px-4 py-2 bg-accent-start hover:bg-accent-end rounded-md transition-colors"><i data-lucide="plus" class="w-5 h-5 mr-2"></i>Добавить провайдера</button></div><div class="bg-bg-element/50 p-6 rounded-lg glassmorphism"><h3 class="text-xl font-semibold mb-4">Провайдеры API</h3><div id="providers-list" class="space-y-4"></div></div></div>`; }
        function renderProviders() { const l = document.getElementById('providers-list'); if (!l) return; if (state.providers.length === 0) { l.innerHTML = `<p class="text-text-secondary">Нет провайдеров.</p>`; return; } l.innerHTML = state.providers.map(p => { const k = (p.apiKeys && p.apiKeys.length) || 0; return `<div class="bg-bg-element p-3 rounded-md flex items-center justify-between"><div><p class="font-bold">${p.name}</p><p class="text-sm text-text-secondary">${p.model} • ${p.baseUrl}${p.path} • (ключей: ${k})</p></div><div class="flex items-center space-x-2"><button class="edit-provider-btn text-text-secondary hover:text-accent-start" data-id="${p.id}"><i data-lucide="edit" class="w-5 h-5"></i></button><button class="delete-provider-btn text-text-secondary hover:text-red-400" data-id="${p.id}"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div></div>` }).join(''); lucide.createIcons(); }
        
        function setupChatViewEventListeners() { const f = document.getElementById('chat-form'), i = document.getElementById('chat-input'), t = document.getElementById('chat-title-input'), p = document.getElementById('provider-select'), r = document.getElementById('role-select'), m = document.getElementById('chat-messages'); f?.addEventListener('submit', handleChatSubmit); i?.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); f.requestSubmit(); } }); i?.addEventListener('input', () => { i.style.height = 'auto'; i.style.height = (i.scrollHeight) + 'px'; }); const save = (field, value) => { const ref = doc(db, `artifacts/${appId}/users/${userId}/sessions`, state.activeSessionId); updateDoc(ref, { [field]: value }); }; t?.addEventListener('change', (e) => save('title', e.target.value)); p?.addEventListener('change', (e) => save('providerId', e.target.value)); r?.addEventListener('change', (e) => save('roleId', e.target.value)); m?.addEventListener('click', e => { const c = e.target.closest('.copy-code-btn'); if (c) { const code = c.parentElement.querySelector('pre code'); if (code) { copyToClipboard(code.innerText); c.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-green-400"></i>'; lucide.createIcons(); setTimeout(() => { c.innerHTML = '<i data-lucide="copy" class="w-4 h-4"></i>'; lucide.createIcons(); }, 2000); } } }); }
        function setupNotepadViewEventListeners() { const t = document.getElementById('note-title-input'), c = document.getElementById('note-content-textarea'); const save = () => { if (!state.activeSessionId) return; const ref = doc(db, `artifacts/${appId}/users/${userId}/sessions`, state.activeSessionId); updateDoc(ref, { title: t.value, content: c.value, updatedAt: serverTimestamp() }); }; t?.addEventListener('blur', save); c?.addEventListener('blur', save); }
        function setupRolesViewEventListeners() { document.getElementById('add-new-role-btn')?.addEventListener('click', handleAddRole); }
        function setupSettingsViewEventListeners() { document.getElementById('add-new-provider-btn')?.addEventListener('click', handleAddProvider); }
        
        async function handleChatSubmit(e) { e.preventDefault(); const i = document.getElementById('chat-input'), m = i.value; if (!m.trim() || state.isLoading) return; const sRef = doc(db, `artifacts/${appId}/users/${userId}/sessions`, state.activeSessionId), aSess = state.sessions.find(s => s.id === state.activeSessionId), prov = state.providers.find(p => p.id === aSess.providerId), role = state.roles.find(r => r.id === aSess.roleId); if (!prov) { showModalAlert("Выберите провайдера в настройках."); return; } const keys = prov.apiKeys || []; if (keys.length === 0) { showModalAlert("У провайдера нет API ключей."); return; } const newMsgs = [...(aSess.messages || []), { role: 'user', content: m }]; await updateDoc(sRef, { messages: newMsgs, updatedAt: serverTimestamp() }); i.value = ''; i.style.height = 'auto'; state.isLoading = true; updateLoadingIndicator(); showTypingIndicatorInChat(); let assistantMsg = '', success = false, lastErr = 'Неизвестная ошибка.'; const payload = []; if (role && role.content) { payload.push({ role: 'system', content: role.content }); } payload.push(...newMsgs.map(m => ({ role: m.role, content: m.content }))); const startIdx = prov.currentKeyIndex || 0; for (let i = 0; i < keys.length; i++) { const keyIdx = (startIdx + i) % keys.length, currentKey = keys[keyIdx]; try { const resp = await fetch('/api/proxy', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ targetUrl: new URL(prov.path, prov.baseUrl).href, apiKey: currentKey, payload: { model: prov.model, messages: payload } }) }); if (!resp.ok) throw new Error(`Ошибка прокси ${resp.status}: ${await resp.text()}`); const data = await resp.json(); if (data.error) throw new Error(`Ошибка API: ${data.error?.message || JSON.stringify(data.error)}`); assistantMsg = data.choices.message.content; success = true; await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/providers`, prov.id), { currentKeyIndex: (keyIdx + 1) % keys.length }); break; } catch (error) { console.error(`Ошибка с ключом ${keyIdx+1}:`, error); lastErr = error.message; } } const finalMsgs = success ? [...newMsgs, { role: 'assistant', content: assistantMsg }] : [...newMsgs, { role: 'assistant', content: `**Ошибка:** Не удалось получить ответ. Последняя ошибка: \n\`\`\`\n${lastErr}\n\`\`\`` }]; state.isLoading = false; await updateDoc(sRef, { messages: finalMsgs, updatedAt: serverTimestamp() }); updateLoadingIndicator(); }
        function showTypingIndicatorInChat() { const c = document.getElementById('chat-messages'); if (!c) return; document.getElementById('loading-message-placeholder')?.remove(); const i = `<div id="loading-message-placeholder" class="message-container flex items-start space-x-4 mb-6"><div class="w-10 h-10 rounded-full bg-gradient-to-br from-accent-start to-accent-end flex-shrink-0 flex items-center justify-center"><i data-lucide="sparkles" class="w-6 h-6 text-white"></i></div><div class="pt-2 typing-indicator"><span></span><span></span><span></span></div></div>`; c.insertAdjacentHTML('beforeend', i); lucide.createIcons(); c.scrollTop = c.scrollHeight; }
        function updateLoadingIndicator() { const f = document.getElementById('chat-form'); if (f) { const b = f.querySelector('button'), t = f.querySelector('textarea'); if (b) b.disabled = state.isLoading; if (t) t.disabled = state.isLoading; } }        
        async function handleAddProvider() { if (state.isLoading) return; state.isLoading = true; try { const ref = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/providers`), { name: 'Новый провайдер', baseUrl: 'https://api.openai.com', path: '/v1/chat/completions', apiKeys: [], model: 'gpt-4o', currentKeyIndex: 0 }); handleOpenEditProviderModal(ref.id); } catch (e) { showModalAlert("Не удалось создать провайдера."); } finally { state.isLoading = false; } }
        async function handleAddRole() { if (state.isLoading) return; state.isLoading = true; try { const ref = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/roles`), { name: 'Новая роль', content: 'Ты — полезный ассистент.', createdAt: serverTimestamp() }); handleOpenEditRoleModal(ref.id); } catch (e) { showModalAlert("Не удалось создать роль."); } finally { state.isLoading = false; } }
        function handleOpenEditProviderModal(id) { const p = state.providers.find(p => p.id === id); if (!p) return; const keys = p.apiKeys || []; document.getElementById('edit-provider-id').value = p.id; document.getElementById('edit-provider-name').value = p.name; document.getElementById('edit-provider-url').value = p.baseUrl; document.getElementById('edit-provider-path').value = p.path; document.getElementById('edit-provider-keys').value = keys.join('\n'); document.getElementById('edit-provider-model').value = p.model; editProviderModal.classList.remove('hidden'); }
        function handleOpenEditRoleModal(id) { const r = state.roles.find(r => r.id === id); if (!r) return; document.getElementById('edit-role-id').value = r.id; document.getElementById('edit-role-name').value = r.name; document.getElementById('edit-role-content').value = r.content; editRoleModal.classList.remove('hidden'); }
        async function handleEditProviderSubmit(e) { e.preventDefault(); const id = document.getElementById('edit-provider-id').value; if (!id) return; const n = document.getElementById('edit-provider-name').value, u = document.getElementById('edit-provider-url').value, p = document.getElementById('edit-provider-path').value, k = document.getElementById('edit-provider-keys').value, m = document.getElementById('edit-provider-model').value; const keys = k.split(/\r?\n/).map(i => i.trim()).filter(Boolean); if (keys.length === 0) { showModalAlert("Введите API ключ."); return; } const ref = doc(db, `artifacts/${appId}/users/${userId}/providers`, id); const oP = state.providers.find(p => p.id === id); const kC = JSON.stringify((oP.apiKeys || []).sort()) !== JSON.stringify(keys.sort()); const data = { name:n, baseUrl:u, path:p, apiKeys:keys, model:m }; if (kC) data.currentKeyIndex = 0; await updateDoc(ref, data); editProviderModal.classList.add('hidden'); }
        async function handleEditRoleSubmit(e) { e.preventDefault(); const id = document.getElementById('edit-role-id').value; if (!id) return; await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/roles`, id), { name: document.getElementById('edit-role-name').value, content: document.getElementById('edit-role-content').value }); editRoleModal.classList.add('hidden'); }
        function copyToClipboard(t) { navigator.clipboard.writeText(t).catch(err => console.error(err)); }
        function showConfirmModal(m, cb) { confirmModalText.textContent = m; confirmModalCallback = cb; confirmModalYesBtn.classList.remove('hidden'); confirmModalNoBtn.textContent = 'Нет'; confirmModal.classList.remove('hidden'); }
        function hideConfirmModal() { confirmModal.classList.add('hidden'); confirmModalCallback = null; }
        function showModalAlert(m) { confirmModalText.textContent = m; confirmModalYesBtn.classList.add('hidden'); confirmModalNoBtn.textContent = 'OK'; confirmModal.classList.remove('hidden'); confirmModalCallback = () => { confirmModalYesBtn.classList.remove('hidden'); confirmModalNoBtn.textContent = 'Нет'; }; }
        
        function setupGlobalEventListeners() {
            mainNavItems.forEach(item => { item.addEventListener('click', () => { state.activeTab = item.dataset.tab; const first = state.sessions.find(s => s.type === state.activeTab); state.activeSessionId = first ? first.id : null; render(); }); });
            
            const createNewItem = async (type) => {
                try {
                    // [ИСПРАВЛЕНО] - Исправлена ошибка state.providers.id -> state.providers.id
                    const providerId = state.providers.length > 0 ? state.providers.id : null;
                    const newSessionData = type === 'chat'
                        ? { type: 'chat', title: 'Новый чат', messages: [], providerId: providerId, roleId: '', createdAt: serverTimestamp(), updatedAt: serverTimestamp() }
                        : { type: 'notepad', title: 'Новая заметка', content: '', createdAt: serverTimestamp(), updatedAt: serverTimestamp() };
                    const newSessionRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/sessions`), newSessionData);
                    state.activeSessionId = newSessionRef.id;
                    render();
                    if (window.innerWidth < 1024) { sidebar.classList.remove('open'); sidebarBackdrop.classList.add('hidden'); }
                } catch (error) {
                    console.error("НЕ УДАЛОСЬ СОЗДАТЬ ЭЛЕМЕНТ:", error);
                    showModalAlert("Ошибка при создании нового элемента. Проверьте консоль.");
                }
            };
    
            newChatBtn.addEventListener('click', () => createNewItem('chat'));
            newNoteBtn.addEventListener('click', () => createNewItem('notepad'));
            document.getElementById('sidebar-toggle-btn').addEventListener('click', () => { if (window.innerWidth < 1024) { sidebar.classList.toggle('open'); sidebarBackdrop.classList.toggle('hidden'); } else { state.isSidebarCollapsed = !state.isSidebarCollapsed; updateSidebarView(); } });
            sidebarBackdrop.addEventListener('click', () => { sidebar.classList.remove('open'); sidebarBackdrop.classList.add('hidden'); });
            window.addEventListener('resize', updateSidebarView);
    
            document.body.addEventListener('click', (e) => {
                const delSessBtn = e.target.closest('.delete-session-btn'); if (delSessBtn) { showConfirmModal('Удалить этот элемент?', () => deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/sessions`, delSessBtn.dataset.id))); }
                const delMsgBtn = e.target.closest('.delete-message-btn'); if (delMsgBtn) { const idx = parseInt(delMsgBtn.dataset.messageIndex, 10), sess = state.sessions.find(s => s.id === state.activeSessionId); if (sess && !isNaN(idx)) { showConfirmModal('Удалить это сообщение?', async () => { const newMsgs = sess.messages.filter((_, i) => i !== idx); await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/sessions`, state.activeSessionId), { messages: newMsgs }); }); } }
                const delProvBtn = e.target.closest('.delete-provider-btn'); if (delProvBtn) { showConfirmModal('Удалить провайдера?', () => deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/providers`, delProvBtn.dataset.id))); }
                const editProvBtn = e.target.closest('.edit-provider-btn'); if (editProvBtn) { handleOpenEditProviderModal(editProvBtn.dataset.id); }
                const delRoleBtn = e.target.closest('.delete-role-btn'); if (delRoleBtn) { showConfirmModal('Удалить эту роль?', () => deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/roles`, delRoleBtn.dataset.id))); }
                const editRoleBtn = e.target.closest('.edit-role-btn'); if (editRoleBtn) { handleOpenEditRoleModal(editRoleBtn.dataset.id); }
            });
            
            confirmModalYesBtn.addEventListener('click', () => { if (confirmModalCallback) confirmModalCallback(); hideConfirmModal(); });
            confirmModalNoBtn.addEventListener('click', () => { if(confirmModalNoBtn.textContent === 'OK' && confirmModalCallback) confirmModalCallback(); hideConfirmModal(); });
            editProviderForm?.addEventListener('submit', handleEditProviderSubmit);
            editProviderCancelBtn?.addEventListener('click', () => editProviderModal.classList.add('hidden'));
            editRoleForm?.addEventListener('submit', handleEditRoleSubmit);
            editRoleCancelBtn?.addEventListener('click', () => editRoleModal.classList.add('hidden'));
            document.getElementById('google-signin-btn')?.addEventListener('click', async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (e) { showModalAlert("Ошибка входа: " + e.message); }});
            document.getElementById('sign-out-btn')?.addEventListener('click', (e) => { e.preventDefault(); signOut(auth); });
        }
        
        function attachFirestoreListeners() {
            unsubscribeSessions(); unsubscribeProviders(); unsubscribeRoles();
            if (!userId) return;
            unsubscribeSessions = onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/sessions`), (snap) => { state.sessions = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (b.updatedAt?.toMillis() || 0) - (a.updatedAt?.toMillis() || 0)); if (!state.sessions.some(s => s.id === state.activeSessionId)) { const f = state.sessions.find(s => s.type === state.activeTab); state.activeSessionId = f ? f.id : null; } if (!state.isLoading) render(); }, e => console.error(e));
            unsubscribeProviders = onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/providers`), (snap) => { state.providers = snap.docs.map(d => ({ id: d.id, ...d.data() })); if (state.activeTab === 'settings' || state.activeTab === 'chat') { if (!state.isLoading) render(); } }, e => console.error(e));
            unsubscribeRoles = onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/roles`), (snap) => { state.roles = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0)); if (state.activeTab === 'roles' || state.activeTab === 'chat') { if (!state.isLoading) render(); } }, e => console.error(e));
        }
    
        function resetState() {
            unsubscribeSessions(); unsubscribeProviders(); unsubscribeRoles();
            userId = null;
            state = { activeTab: 'chat', activeSessionId: null, sessions: [], providers: [], roles: [], isLoading: false, isAuthReady: false, isSidebarCollapsed: window.innerWidth >= 1024 };
            sidebar.classList.remove('collapsed', 'open');
            sidebarList.innerHTML = '<div class="p-4 text-center text-gray-500">Пожалуйста, войдите.</div>';
            mainContent.innerHTML = getEmptyStateHTML('chat');
        }
    
        async function init() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    document.getElementById('auth-section').classList.remove('hidden');
                    if (user) {
                        userId = user.uid;
                        document.getElementById('google-signin-btn').classList.add('hidden');
                        document.getElementById('user-profile').classList.remove('hidden');
                        document.getElementById('user-name').textContent = user.displayName || 'Аноним';
                        document.getElementById('user-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'A'}`;
                        state.isAuthReady = true;
                        attachFirestoreListeners();
                    } else {
                        resetState();
                        document.getElementById('google-signin-btn').classList.remove('hidden');
                        document.getElementById('user-profile').classList.add('hidden');
                        state.isAuthReady = false; 
                        render();
                    }
                    renderMainNav(); 
                    updateSidebarView();
                });
                setupGlobalEventListeners();
            } catch (error) {
                console.error("КРИТИЧЕСКАЯ ОШИБКА ИНИЦИАЛИЗАЦИИ:", error);
                mainContent.innerHTML = `<div class="p-4 text-red-400"><strong>Ошибка инициализации Firebase:</strong> ${error.message}.</div>`;
            }
        }
        
        init();
    </script>

</body>
</html>
