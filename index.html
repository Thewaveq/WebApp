<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Multi-Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root {
            --bg-main: #1e1e1e;
            --bg-sidebar: #252526;
            --bg-element: #333333;
            --bg-input: #3c3c3c;
            --text-primary: #f5f5f5;
            --text-secondary: #b0b0b0;
            --accent: #0e639c;
            --accent-hover: #1177bb;
            --border-color: #4a4a4a;
            --danger: #e53e3e;
            --danger-hover: #c53030;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-primary); }
        input, textarea, select { color: var(--text-primary); }
        input::placeholder, textarea::placeholder { color: var(--text-secondary); }
        .bg-input { background-color: var(--bg-input); }
        .sidebar-item.active { background-color: var(--accent); color: white; }
        .sidebar-item:hover { background-color: var(--bg-element); }
        .main-nav-item.active { border-bottom: 2px solid var(--accent); color: white; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-sidebar); }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
        .typing-indicator span { height: 8px; width: 8px; background-color: var(--accent); border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .prose { color: var(--text-primary); }
        .prose h1, .prose h2, .prose h3 { color: white; border-bottom: 1px solid var(--border-color); }
        .prose a { color: var(--accent-hover); }
        .prose pre { background-color: #282c34; padding: 1rem; border-radius: 0.5rem; position: relative; }
        .prose code { background-color: var(--bg-element); padding: 0.2rem 0.4rem; border-radius: 0.3rem; }
        .prose pre code { background-color: transparent; padding: 0; border-radius: 0; }
        .prose blockquote { border-left-color: var(--accent); }
        .copy-code-btn { position: absolute; top: 0.5rem; right: 0.5rem; background-color: var(--bg-element); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 0.3rem; padding: 0.25rem; opacity: 0.5; transition: opacity 0.2s; }
        .prose pre:hover .copy-code-btn { opacity: 1; }
        .copy-code-btn:hover { background-color: var(--bg-input); color: var(--text-primary); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: var(--bg-element); padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        .sidebar { transition: width 0.3s ease-in-out; }
        .sidebar.collapsed { width: 0; padding: 0; overflow: hidden; border-right: none; }

        /* --- ИЗМЕНЕНИЕ 1: Стили для мобильной адаптации --- */
        #mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30; /* Ниже чем сайдбар, но выше контента */
            transition: opacity 0.3s ease-in-out;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                z-index: 40;
                width: 80%; /* Ширина открытого меню */
                max-width: 300px;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                border-right: 1px solid var(--border-color);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            /* На мобильных основной контент всегда занимает всю ширину */
            main {
                width: 100%;
            }
        }
    </style>
</head>
<body class="h-screen w-screen flex overflow-hidden">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, deleteDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ГЛОБАЛЬНОЕ СОСТОЯНИЕ И КОНФИГУРАЦИЯ ---
        const firebaseConfig = { /* ... без изменений ... */ };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let db, auth, userId;
        let unsubscribeSessions = () => {}, unsubscribeProviders = () => {};

        let state = {
            activeTab: 'chat',
            activeSessionId: null,
            sessions: [],
            providers: [],
            isLoading: false,
            isAuthReady: false,
            isSidebarCollapsed: false,
        };
        
        let confirmModalCallback = null;
        const markdownConverter = new showdown.Converter({ tables: true, strikethrough: true, tasklists: true, simpleLineBreaks: true, openLinksInNewWindow: true, ghCompatibleHeaderId: true });
        
        // --- DOM Элементы ---
        const sidebar = document.getElementById('sidebar');
        const sidebarList = document.getElementById('sidebar-list');
        const mainContent = document.getElementById('main-content');
        const mainNavItems = document.querySelectorAll('.main-nav-item');
        const newChatBtn = document.getElementById('new-chat-btn');
        const newNoteBtn = document.getElementById('new-note-btn');
        const mobileOverlay = document.getElementById('mobile-overlay'); // ИЗМЕНЕНИЕ 2: Получаем оверлей
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const menuToggleIcon = document.getElementById('menu-toggle-icon');

        // --- ФУНКЦИИ РЕНДЕРИНГА (изменения минимальны) ---
        function render() {
            if (!state.isAuthReady) return;
            renderSidebar();
            renderMainContent();
            renderMainNav();
        }

        function renderSidebar() {
            sidebarList.innerHTML = '';
            const filteredSessions = state.sessions.filter(s => s.type === state.activeTab);
            if (filteredSessions.length > 0) {
                filteredSessions.forEach(session => {
                    const item = document.createElement('div');
                    item.className = `sidebar-item flex justify-between items-center p-2 my-1 rounded-md cursor-pointer transition-colors duration-200 ${session.id === state.activeSessionId ? 'active' : ''}`;
                    item.innerHTML = `<span class="truncate pr-2">${session.title || 'Без названия'}</span><button class="delete-session-btn hidden text-white hover:text-red-400" data-id="${session.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                    item.addEventListener('click', (e) => {
                        if (e.target.closest('.delete-session-btn')) return;
                        state.activeSessionId = session.id;
                        render();
                        closeMobileSidebar(); // Закрываем меню после выбора
                    });
                    item.addEventListener('mouseenter', () => item.querySelector('.delete-session-btn').classList.remove('hidden'));
                    item.addEventListener('mouseleave', () => item.querySelector('.delete-session-btn').classList.add('hidden'));
                    sidebarList.appendChild(item);
                });
            } else {
                 sidebarList.innerHTML = `<div class="text-center text-sm text-gray-500 p-4">Нет ${state.activeTab === 'chat' ? 'чатов' : 'заметок'}.</div>`;
            }
            lucide.createIcons();
        }

        function renderMainContent() { /* ... без изменений ... */ }
        function renderMainNav() { /* ... без изменений ... */ }
        
        // --- ШАБЛОНЫ HTML (без изменений) ---
        function getEmptyStateHTML(type) { /* ... */ }
        function getChatViewHTML(activeSession) { /* ... */ }
        function renderChatMessages(session) { /* ... */ }
        function getNotepadViewHTML(activeSession) { /* ... */ }
        function getSettingsViewHTML() { /* ... */ }
        function renderProviders() { /* ... */ }
        
        // --- ОБРАБОТЧИКИ СОБЫТИЙ И ЛОГИКА ---
        function setupChatViewEventListeners() { /* ... */ }
        function setupNotepadViewEventListeners() { /* ... */ }
        function setupSettingsViewEventListeners() { /* ... */ }
        async function handleChatSubmit(e) { /* ... */ }
        function updateLoadingIndicator() { /* ... */ }
        async function handleAddProvider(e) { /* ... */ }
        function copyToClipboard(text) { /* ... */ }
        function showConfirmModal(message, onConfirm) { /* ... */ }
        function hideConfirmModal() { /* ... */ }
        function showModalAlert(message) { /* ... */ }


        // --- ИЗМЕНЕНИЕ 3: Логика для мобильного меню ---
        function openMobileSidebar() {
            if (window.innerWidth <= 768) {
                sidebar.classList.add('open');
                mobileOverlay.classList.remove('hidden');
            }
        }

        function closeMobileSidebar() {
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('open');
                mobileOverlay.classList.add('hidden');
            }
        }
        
        function handleMenuToggle() {
            // Десктопное поведение
            if (window.innerWidth > 768) {
                state.isSidebarCollapsed = !state.isSidebarCollapsed;
                sidebar.classList.toggle('collapsed', state.isSidebarCollapsed);
                menuToggleIcon.setAttribute('data-lucide', state.isSidebarCollapsed ? 'panel-right-close' : 'panel-left-close');
                lucide.createIcons();
            } else { // Мобильное поведение
                if (sidebar.classList.contains('open')) {
                    closeMobileSidebar();
                } else {
                    openMobileSidebar();
                }
            }
        }

        function handleResize() {
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                // Если мы на мобильном, иконка всегда "меню"
                menuToggleIcon.setAttribute('data-lucide', 'menu');
                // Убираем десктопный класс 'collapsed', если он был
                sidebar.classList.remove('collapsed');
                state.isSidebarCollapsed = false;
            } else {
                 // Если мы на десктопе, иконка зависит от состояния
                menuToggleIcon.setAttribute('data-lucide', state.isSidebarCollapsed ? 'panel-right-close' : 'panel-left-close');
                // Убираем мобильные классы
                sidebar.classList.remove('open');
                mobileOverlay.classList.add('hidden');
            }
            lucide.createIcons();
        }


        // --- ГЛАВНЫЕ ОБРАБОТЧИКИ И ИНИЦИАЛИЗАЦИЯ ---
        function setupGlobalEventListeners() {
            mainNavItems.forEach(item => {
                item.addEventListener('click', () => {
                    state.activeTab = item.dataset.tab;
                    const firstSessionOfType = state.sessions.find(s => s.type === state.activeTab);
                    state.activeSessionId = firstSessionOfType ? firstSessionOfType.id : null;
                    render();
                });
            });

            newChatBtn.addEventListener('click', async () => { /* ... */ });
            newNoteBtn.addEventListener('click', async () => { /* ... */ });
            
            // ИЗМЕНЕНИЕ 4: Назначаем новые обработчики
            menuToggleBtn.addEventListener('click', handleMenuToggle);
            mobileOverlay.addEventListener('click', closeMobileSidebar);
            window.addEventListener('resize', handleResize);

            document.body.addEventListener('click', async (e) => { /* ... */ });
            confirmModalYesBtn.addEventListener('click', () => { /* ... */ });
            confirmModalNoBtn.addEventListener('click', () => { /* ... */ });
            document.getElementById('google-signin-btn')?.addEventListener('click', async () => { /* ... */ });
            document.getElementById('sign-out-btn')?.addEventListener('click', async (e) => { /* ... */ });
        }
        
        function attachFirestoreListeners() { /* ... без изменений ... */ }
        function resetState() { /* ... без изменений ... */ }

        async function init() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => { /* ... без изменений ... */ });
                
                setupGlobalEventListeners();
                handleResize(); // Первоначальная настройка иконки и состояния при загрузке

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                mainContent.innerHTML = `<div class="p-4 text-red-400"><strong>Ошибка инициализации Firebase:</strong> ${error.message}.</div>`;
            }
        }
        
        init();
    </script>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-1/4 max-w-xs bg-bg-sidebar flex flex-col h-full sidebar flex-shrink-0">
         <!-- Содержимое сайдбара без изменений -->
         <div class="p-4 border-b border-border-color flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center"><i data-lucide="sparkles" class="w-6 h-6 mr-2 text-accent"></i>AI Multi-Tool</h1>
        </div>
        <div class="p-2 flex-shrink-0">
            <button id="new-chat-btn" class="w-full flex items-center justify-center bg-accent hover:bg-accent-hover text-white font-bold py-2 px-4 rounded transition-colors">
                <i data-lucide="plus" class="w-5 h-5 mr-2"></i>Новый чат
            </button>
             <button id="new-note-btn" class="w-full flex items-center justify-center bg-accent hover:bg-accent-hover text-white font-bold py-2 px-4 rounded transition-colors hidden">
                <i data-lucide="plus" class="w-5 h-5 mr-2"></i>Новая заметка
            </button>
        </div>
        <nav id="sidebar-list" class="flex-grow overflow-y-auto p-2"></nav>
        <div id="auth-section" class="p-3 border-t border-border-color text-center hidden">
            <button id="google-signin-btn" class="w-full flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded transition-colors text-sm">
                <svg class="w-4 h-4 mr-2" viewBox="0 0 48 48" fill="currentColor"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                Войти через Google
            </button>
            <div id="user-profile" class="hidden flex items-center text-left">
                <img id="user-avatar" class="w-8 h-8 rounded-full mr-2 flex-shrink-0">
                <div class="text-xs overflow-hidden">
                    <p id="user-name" class="font-semibold text-text-primary truncate"></p>
                    <a href="#" id="sign-out-btn" class="text-red-400 hover:text-red-500">Выйти</a>
                </div>
            </div>
        </div>
    </aside>

    <!-- ИЗМЕНЕНИЕ 5: Добавлен оверлей для мобильных устройств -->
    <div id="mobile-overlay" class="hidden"></div>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col h-full">
        <nav class="flex-shrink-0 border-b border-border-color flex items-center">
            <!-- Кнопка теперь имеет универсальный ID -->
            <button id="menu-toggle-btn" class="p-3 hover:bg-bg-element transition-colors border-r border-border-color">
                <i id="menu-toggle-icon" data-lucide="panel-left-close" class="w-5 h-5"></i>
            </button>
            <div class="flex space-x-4 px-4">
                <button data-tab="chat" class="main-nav-item py-3 px-2 text-text-secondary hover:text-white transition-colors active">Чат</button>
                <button data-tab="notepad" class="main-nav-item py-3 px-2 text-text-secondary hover:text-white transition-colors">Блокнот</button>
                <button data-tab="settings" class="main-nav-item py-3 px-2 text-text-secondary hover:text-white transition-colors">Настройки</button>
            </div>
        </nav>
        <div id="main-content" class="flex-grow overflow-y-auto">
            <!-- Содержимое -->
        </div>
    </main>
    
    <!-- Модальное окно подтверждения -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <!-- Содержимое модального окна -->
    </div>

</body>
</html>
